<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bar</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: #f5f5f5;
            padding: 0 0 80px;
            height: 100%;
            overflow: hidden;
        }

        #scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Damit es √ºber allem liegt */
        }

        #reader {
            width: 100%;
            height: 100%;
        }

        .header {
            background: #333;
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .config-btn {
            position: absolute;
            right: 16px;
            top: 16px;
            background: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        .main, .config {
            padding: 16px;
        }

        .drinks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
        }

        .drink-item {
            background: white;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .drink-emoji {
            font-size: 1.8rem;
        }

        .drink-name {
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: 6px;
        }

        .drink-name .unitprice {
            font-size: 0.7rem;
            font-weight: 300;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 8px;
            gap: 8px;
        }

        .controls button {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            border: none;
            cursor: pointer;
            color: white;
        }

        .btn-plus {
            background: #28a745;
        }

        .btn-minus {
            background: #dc3545;
        }

        .counter {
            font-size: 1rem;
            font-weight: bolder;
            min-width: 10px;
        }

        .summary {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            font-size: 1.1rem;
        }

        .config {
            display: none;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            font-size: 1rem;
        }

        .drink-config {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 10px 16px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-add {
            background: #007bff;
            color: white;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            width: 100%;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
        }
        .qr-section {
            text-align: center;
            margin-top: 20px;
        }
        #qrcode {
            margin: 10px auto;
        }
    </style>
</head>
<body>
<div class="header">
    üç∫
    <button class="config-btn" onclick="toggleView()">‚öôÔ∏è</button>
</div>

<div class="main">
    <div class="drinks-grid" id="drinksGrid"></div>
</div>

<div class="config">
    <h2>Getr√§nk hinzuf√ºgen</h2>
    <div class="form-group">
        <label for="drinkName">Name</label>
        <input type="text" id="drinkName" />
    </div>
    <div class="form-group">
        <label for="drinkPrice">Preis (‚Ç¨)</label>
        <input type="number" step="0.01" id="drinkPrice" />
    </div>
    <div class="form-group">
        <label for="drinkEmoji">Emoji</label>
        <select id="drinkEmoji">
            <option value="üç∫">üç∫</option>
            <option value="üç∫üö´">üç∫üö´</option>
            <option value="üç∑">üç∑</option>
            <option value="ü•É">ü•É</option>
            <option value="ü•Ç">ü•Ç</option>
            <option value="üç∏">üç∏</option>
            <option value="ü´ô">ü´ô</option>
            <option value="üö∞">üö∞</option>
            <option value="üçπ">üçπ</option>
            <option value="üçæ">üçæ</option>
            <option value="üßÉ">üßÉ</option>
            <option value="ü•§">ü•§</option>
            <option value="üßã">üßã</option>
            <option value="‚òï">‚òï</option>
            <option value="ü´ó">ü´ó</option>
        </select>
    </div>
    <button class="btn btn-add" onclick="addDrink()">‚úÖ Hinzuf√ºgen</button>

    <div id="configuredDrinks"></div>
    <button class="btn btn-back" onclick="toggleView()">‚Üê Zur√ºck</button>
    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-delete" onclick="resetDefaultDrinks()">Getr√§nkeliste zur√ºcksetzen</button>
    </div>

    <!-- üîπ QR-Code Sharing Section -->
    <div class="qr-section">
        <button class="btn btn-add" onclick="generateQR()">üì§ Teilen</button>
        <div id="qrcode"></div>
        <button class="btn btn-add" onclick="startScanner()">üì• Laden</button>
        <div id="scanner-container">
            <div id="reader"></div>
            <button class="btn btn-back" style="position:absolute; top:10px; right:10px;" onclick="closeScanner()">‚úñÔ∏è Schlie√üen</button>
        </div>
    </div>
</div>

<div class="summary">
    <span>Gesamt: <strong id="totalPrice">‚Ç¨0,00</strong></span>
    <button class="btn-delete" onclick="resetOrder()">üóëÔ∏è L√∂schen</button>
</div>

<!-- üîπ Libraries for QR + compression -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string/libs/lz-string.min.js"></script>
<script src="./lib/qr-code.js"></script>

<script>
    let drinks = [];
    let order = {};
    let view = 'main';

    let defaultDrinks = [
        {
            "id": 1754314600229,
            "name": "Bier",
            "price": 5,
            "emoji": "üç∫"
        },
        {
            "id": 1754314547340,
            "name": "Limonade",
            "price": 4.5,
            "emoji": "ü•§"
        },
        {
            "id": 1754314508965,
            "name": "Wasser",
            "price": 3,
            "emoji": "üö∞"
        },
        {
            "id": 1754314275641,
            "name": "Schorle",
            "price": 3.5,
            "emoji": "üßÉ"
        },
        {
            "id": 1754314569245,
            "name": "Alk. freie Biere",
            "price": 8,
            "emoji": "üç∫üö´"
        },
        {
            "id": 1754314451815,
            "name": "Schnaps",
            "price": 2.5,
            "emoji": "ü•É"
        },
        {
            "id": 1754314641597,
            "name": "Pfand zur√ºck",
            "price": -2,
            "emoji": "ü´ô"
        }
    ];

    window.onload = () => {
        const stored = localStorage.getItem('drinks');
        drinks = stored ? JSON.parse(stored) : defaultDrinks;
        const ord = localStorage.getItem('order');
        order = ord ? JSON.parse(ord) : {};
        drinks.forEach(d => order[d.id] ??= 0);
        render();
    };

    function save() {
        localStorage.setItem('drinks', JSON.stringify(drinks));
        localStorage.setItem('order', JSON.stringify(order));
    }

    const CONFIG_PASSWORD = "sternschnuppe"; // üîí Passwort hier festlegen

    function toggleView() {
        if (view === 'main') {
            // üîí jedes Mal Passwort abfragen
            const pw = prompt("Passwort eingeben:");
            if (pw !== CONFIG_PASSWORD) {
                alert("Falsches Passwort!");
                return; // nicht umschalten
            }
        }

        view = view === 'main' ? 'config' : 'main';
        document.querySelector('.main').style.display = view === 'main' ? 'block' : 'none';
        document.querySelector('.config').style.display = view === 'config' ? 'block' : 'none';
        if (view === 'config') renderConfigured();
    }

    function addDrink() {
        const name = document.getElementById('drinkName').value.trim();
        const price = parseFloat(document.getElementById('drinkPrice').value);
        const emoji = document.getElementById('drinkEmoji').value;
        if (!name || isNaN(price)) return alert('Bitte alle Felder ausf√ºllen.');

        const id = Date.now();
        drinks.push({ id, name, price, emoji });
        order[id] = 0;
        save();
        render();
        renderConfigured();
        document.getElementById('drinkName').value = '';
        document.getElementById('drinkPrice').value = '';
    }

    function removeDrink(id) {
        drinks = drinks.filter(d => d.id !== id);
        delete order[id];
        save();
        render();
        renderConfigured();
    }

    function update(id, delta) {
        order[id] = Math.max(0, (order[id] || 0) + delta);
        save();
        render();
    }

    function resetOrder() {
        Object.keys(order).forEach(id => order[id] = 0);
        save();
        render();
    }

    function render() {
        const grid = document.getElementById('drinksGrid');
        grid.innerHTML = drinks.map(d => `
        <div class="drink-item">
          <div class="drink-emoji">${d.emoji}</div>
          <div class="drink-name">${d.name}<br><span class="unitprice">‚Ç¨${d.price.toFixed(2)}</span></div>
          <div class="counter">${order[d.id] || 0}</div>
          <div class="controls">
            <button class="btn-minus" onclick="update(${d.id}, -1)">‚àí</button>
            <button class="btn-plus" onclick="update(${d.id}, 1)">+</button>
          </div>
        </div>
      `).join('');
        const total = drinks.reduce((sum, d) => sum + (order[d.id] || 0) * d.price, 0);
        document.getElementById('totalPrice').textContent = `‚Ç¨${total.toFixed(2).replace('.', ',')}`;
    }

    function renderConfigured() {
        const cont = document.getElementById('configuredDrinks');
        cont.innerHTML = drinks.map(d => `
        <div class="drink-config">
          <span>${d.emoji} ${d.name} ‚Äì ‚Ç¨${d.price.toFixed(2)}</span>
          <button class="btn-delete" onclick="removeDrink(${d.id})">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function resetDefaultDrinks() {
        if (window.confirm('Getr√§nkeliste wirklich zur√ºcksetzen? Neu hinzugef√ºgte Getr√§nke gehen verloren.')) {
            drinks = defaultDrinks;
            save();
            render();
            renderConfigured();
        }
    }

    /* üîπ NEW QR SHARE FUNCTIONS */
    function generateQR() {
        const json = JSON.stringify(drinks);
        const compressed = LZString.compressToEncodedURIComponent(json);
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: compressed,
            width: 256,
            height: 256
        });
    }

    function startScanner() {
        document.getElementById("scanner-container").style.display = "flex";

        window.html5QrCode = new Html5Qrcode("reader"); // make it global
        html5QrCode.start(
            { facingMode: "environment" },
            {
                fps: 20,
                qrbox: 0, // scannt das ganze Kamerabild
                experimentalFeatures: { useBarCodeDetectorIfSupported: true }
            },
            qrMessage => {
                try {
                    const json = LZString.decompressFromEncodedURIComponent(qrMessage);
                    drinks = JSON.parse(json);
                    order = {};
                    drinks.forEach(d => order[d.id] = 0);
                    save();
                    render();
                    renderConfigured();
                    alert("Getr√§nkeliste importiert!");
                    html5QrCode.stop();
                    document.getElementById("scanner-container").style.display = "none";
                } catch (e) {
                    alert("Fehler beim Importieren");
                }
            },
            errorMessage => {
                // optional: Scan-Fehler ignorieren
            }
        );
    }

    function closeScanner() {
        const container = document.getElementById("scanner-container");
        container.style.display = "none";

        // Stop the scanner if it's running
        if (window.html5QrCode) {
            window.html5QrCode.stop().catch(() => {});
        }
    }

</script>
</body>
</html>